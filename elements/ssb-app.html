<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-pages/core-pages.html">
<link rel="import" href="ssb-tabs.html">

<polymer-element name="ssb-app">
    <template>
        <style>
            :host {
                display: flex;
                flex-direction: column;
                height: 100%; /* required for webview to get any height */
                overflow: hidden;
            }
        </style>

        <ssb-tabs selected="{{activeTabId}}"
                on-core-activate="{{onTabActivated}}">
            <template repeat="{{tab in tabs}}">
                <ssb-tab name="{{tab.id}}">
                    <img src="{{tab.icon || defaultIcon}}">
                    {{tab.title}}
                </ssb-tab>
            </template>
        </ssb-tabs>

        <core-pages flex selected="{{activeTabId}}">
            <template repeat="{{tab in tabs}}">
                <webview name="{{tab.id}}" src="{{tab.url}}"
                         on-new-window="{{onNewWindowRequested}}"
                         on-page-title-set="{{onPageTitleSet}}"></webview>
            </template>
        </core-pages>
    </template>

    <script>
        'use strict';

        const escapeRegExp = require('lodash/string/escapeRegExp');
        const openExternal = require('shell').openExternal;
        const urlParse = require('url').parse;

        const defaultAppTitle = 'Inbox App';
        const defaultIcon = 'default-tab-icon.png';

        const uniqueId = (function() {
            let _uniqueId = 0;
            return function uniqueId(prefix) {
                return (prefix || '') + (_uniqueId++);
            };
        }());

        const defaultTabs = [{
            id: uniqueId('tab'),
            title: 'Inbox',
            icon: 'https://ssl.gstatic.com/bt/C3341AA7A1A076756462EE2E5CD71C11/ic_product_inbox_16dp_r2_2x.png',
            url: 'https://inbox.google.com'
        }, {
            id: uniqueId('tab'),
            title: 'Calendar',
            icon: 'https://calendar.google.com/googlecalendar/images/favicon_v2014_30.ico',
            url: 'https://www.google.com/calendar'
        }, {
            id: uniqueId('tab'),
            title: 'Inbox 2',
            icon: 'https://ssl.gstatic.com/bt/C3341AA7A1A076756462EE2E5CD71C11/ic_product_inbox_16dp_r2_2x.png',
            url: 'https://inbox.google.com/u/0/?authuser=1'
        }];

        // URL patterns that should open in the SSB, rather than externally.
        // Strings match at beginning of url; use /regexp/ for more-complicated tests.
        const defaultOpenInTabPatterns = [
            'https://accounts.google.com/AddSession',
            'https://contacts.google.com',
            'https://inbox.google.com',
            'https://mail.google.com',
            'https://www.google.com/calendar',
            'https://www.google.com/contacts',
            'https://www.google.com/voice'
        ];

        function compilePatterns(patterns) {
            let regexps = patterns.map(function(pattern) {
                if (pattern instanceof RegExp) {
                    return pattern.source;
                } else {
                    // Convert strings to regexps that match the beginning of the url
                    return '^' + escapeRegExp(pattern);
                }
            });
            return new RegExp(regexps.join('|'));
        }

        function getDomain(url) {
            return urlParse(url).hostname;
        }


        Polymer({
            tabs: defaultTabs, // TODO: restore from previous session
            openInTabRegExp: compilePatterns(defaultOpenInTabPatterns), // TODO: move to prefs
            defaultIcon: defaultIcon,

            created: function() {
                this.activeTabId = this.tabs[0].id;
            },

            ready: function() {
                this.updateAppTitleFromActiveTab();
            },

            getActiveTab: function() {
                return this.getTabById(this.activeTabId);
            },

            getTabById: function(tabId) {
                for (let i = 0; i < this.tabs.length; i++) {
                    if (this.tabs[i].id == tabId) {
                        return this.tabs[i];
                    }
                }
                return false;
            },

            newTab: function(url, options) {
                options = options || {};
                let domain = getDomain(url),
                    title = options.title || domain || 'New Tab',
                    id = options.id || uniqueId('tab'),
                    activate = (options.activate === undefined ? true : options.activate);

                this.tabs.push({
                    id: id,
                    title: title,
                    url: url
                });
                if (activate) {
                    this.activeTabId = id;
                }
            },

            updateAppTitleFromActiveTab: function() {
                let tab = this.getActiveTab(),
                    title = '';
                if (tab) {
                    title = (tab.title || tab.url || '').trim();
                }
                if (!title) {
                    title = defaultAppTitle;
                }
                if (document.title != title) {
                    document.title = title;
                }
            },

            onTabActivated: function(e) {
                this.updateAppTitleFromActiveTab();
            },

            onNewWindowRequested: function(e) {
                let url = e.url,
                    disposition = e.disposition,
                    activate = /^foreground/.test(disposition); // foreground-tab or foreground-window
                    // tabId = e.target.attributes.name.value,
                    // tab = this.getTabById(tabId),
                    // frameName = e.frameName,

                e.preventDefault(); // not strictly necessary - webview doesn't handle new window anyway

                if (this.openInTabRegExp.test(url)) {
                    this.newTab(url, { activate: activate });
                } else {
                    openExternal(url);
                }
            },

            onPageTitleSet: function(e) {
                let tabId = e.target.attributes.name.value,
                    tab = this.getTabById(tabId),
                    newTitle = e.title;
                if (tab) {
                    tab.title = newTitle;
                    if (tab.id == this.activeTabId) {
                        this.updateAppTitleFromActiveTab();
                    }
                }
            }
        });
    </script>
</polymer-element>
